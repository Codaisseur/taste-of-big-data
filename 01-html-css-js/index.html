<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Movie Recommendations</title>
    <script src='./papaparse.js'></script>
    <script>
    'use strict';

    var movies = new Array();
    var genres = new Array();

    // Callback for how a csv row should be parsed
    function parseMovieDatum(row) {
      var movieDatum = row.data[0];
      try {
        var movieGenres = JSON.parse(movieDatum.genres);
      } catch {
        var movieGenres = [];
      }
      for(var movieGenre of movieGenres){
        var genre = genres.find((genre) => (genre.name === movieGenre.name));
        if (genre === undefined) {
          genre = {
            name: movieGenre.name,
            movies: new Array()
          }
          genres.push(genre);
        }
        genre.movies.push(interestingFields(movieDatum));
      }
      movies.push(interestingFields(movieDatum));
    };

    // What do we need to display to our user?
    function interestingFields(movieDatum){
      return {
        title:    movieDatum.title,
        // overview: movieDatum.overview,
        year:     new Date(Date.parse(movieDatum.release_date)).getFullYear(),
        votes:    movieDatum.vote_count,
        score:    movieDatum.vote_average,
      }
    }

    Papa.parse("tmdb_5000_movies.csv", {
      download: true,
      header: true,
      worker: true,
      dynamicTyping: true,
      // preview: 100, //limit the amount of results | delete when done with setup
      step: parseMovieDatum,
      complete: displayMovies,
    });

    function displayMovies(){
      displayPopularMovies();
      displayMoviesByGenre();
    }

    function displayMoviesByGenre(){
      var parentList = document.getElementById('popular-by-genre')
      for(var genre of genres){
        var genreId = `genre-${genre.name}`;
        var genreElement = document.createElement("div");
        genreElement.id = genreId;
        genreElement.innerHTML = genre.name;
        parentList.appendChild(genreElement);
        renderMovies(bestMovies(genre.movies, 10), genreId);
      }
    }

    function displayPopularMovies(){
      renderMovies(
        bestMovies(movies,  4),
        "most-popular"
      );
    }

    function renderMovies(movies, parentElement){
      var parentList = document.getElementById(parentElement);

      for(var movie of movies){
        var movieHTML = document.createElement('div')
        movieHTML.className = 'movie';
        movieHTML.innerHTML = `
          <span class="movie title">${movie.title}</span>
          <span class="movie year">${movie.year} </span>
          <span class="movie score">${movie.score}</span>
          <span class="movie votes">${movie.votes}</span>`;
        parentList.appendChild(movieHTML);
      };
    }

    //order movies param on score, and return the top 5 of it
    function bestMovies(movies, amount=5){
      removeHardlyRatedMovies(movies);
      return sortMoviesOnScore(movies).slice(0, amount);
    };


    function sortMoviesOnScore(movies){
      return movies.sort((a,b) => b.score - a.score);
    }
    function removeHardlyRatedMovies(movies){
      return movies.filter((movie) => movie.votes > 10);
    }
    </script>
    <script>
      // "use strict";
      // var request = new XMLHttpRequest();
      // request.overrideMimeType("application/json");
      // request.open('GET', 'movies.json');

      // request.onload = function() {
      //   if (request.status >= 200 && request.status < 400) {
      //     let movieData, perYear, relevantMovies;

      //     movieData = JSON.parse(request.responseText);
      //     relevantMovies = movieData.filter(x => x.votes >= 400)
      //     perYear = relevantMovies.reduce(function(accumulator, movie) {
      //       accumulator[movie.year] = accumulator[movie.year] || {}
      //       if ( !(accumulator[movie.year].score) || accumulator[movie.year].score < movie.score) {
      //         accumulator[movie.year].score = movie.score;
      //         accumulator[movie.year].title = movie.title;
      //       }
      //       return accumulator;
      //     }, new Object());
      //     console.log(`raw amount: ${movieData.length}, relevant amount: ${relevantMovies.length}`);
      //     console.table(perYear);
      //   } else {
      //     // We reached our target server, but it returned an error
      //     console.warn("Please return some data!")
      //   }
      // };

      // request.onerror = function() {
      //   console.error("start your server!")
      // };

      // request.send();

  </script>
  <style>
    .movie.header { background-color: lightgrey;}
    .movie { display: grid;  grid-template-columns: 4fr 1fr 1fr 1fr}
    .movie.title { font-size: 150%; grid-column: 1;}
    .movie.year  { grid-column: 2}
    .movie.score { background-color: lightgreen; grid-column: 3}
    .movie.votes {grid-column: 4}
  </style>
  </head>

  <body>
    <h1>Movie Recommendations</h1>

    <ul>
      <div id="most-popular">
        <h3>Most popular movies</h3>
        <div class="movie header">
          <span class="title">title</span>
          <span class="year">year</span>
          <span class="score">score</span>
          <span class="votes">votes</span>
        </div>
      </div>

      <li>Most popular per year</li>
      <div id="popular-by-genre">
        <h3>Most popylar per genre</h3>
      </div>

    </ul>

    <footer>Made with &hearts; at Taste of Code</footer>
  </body>
</html>
